# 3通道DMA控制器

这是一个使用Verilog设计的3通道DMA(直接内存访问)控制器，可以在外设和内存之间进行高效数据传输，无需CPU干预。该DMA控制器支持AHB-Lite总线接口。

## 功能特点

- 支持3个独立的DMA通道
- 支持内存到外设(M2P)和外设到内存(P2M)的传输方向
- 可配置的传输大小和地址
- 支持软件触发和硬件触发传输
- 通道级别的中断管理
- 公平的轮询仲裁机制
- 支持32位数据传输
- 与AHB-Lite总线系统集成

## 项目结构

```
dma_top.v          - 核心DMA控制器顶层模块
dma_controller.v   - 负责寄存器操作和状态管理
dma_channel.v      - DMA通道实现，每个通道处理一个传输流
dma_arbiter.v      - 仲裁器，决定哪个通道可以访问总线
dma_defines.v      - 常量和参数定义
dma_ahb_interface.v - AHB-Lite总线接口
dma_soc_top.v      - 系统级顶层模块，集成DMA和AHB接口
dma_tb.v           - 测试平台
dma_ahb_tb.v       - AHB-Lite集成测试平台
```

## 系统架构

DMA控制器通过AHB-Lite从接口接收配置，通过AHB-Lite主接口访问系统内存，同时直接连接到外设接口进行数据传输。

```
                        +-----------------+
                        |                 |
CPU -----> AHB-Lite ---->  DMA控制器      |
                        |    (从接口)     |
                        |                 |
                        |                 |
                        |    (主接口)     |
内存 <---- AHB-Lite <----                 |
                        |                 |
                        |                 |
外设 <--------------->  |                 |
                        +-----------------+
```

## 寄存器映射

### 全局寄存器 (基址: 0x10000000)

| 偏移量 | 寄存器名称 | 描述 |
|--------|------------|------|
| 0x00   | GLOBAL_CTRL | 全局DMA控制寄存器 |
| 0x04   | GLOBAL_STATUS | 全局状态寄存器 |
| 0x08   | INT_STATUS | 中断状态寄存器 |
| 0x0C   | INT_MASK | 中断掩码寄存器 |

### 通道寄存器 (每个通道占用0x100地址空间)

| 通道 | 基址 |
|------|------|
| 通道0 | 0x10001000 |
| 通道1 | 0x10001100 |
| 通道2 | 0x10001200 |

每个通道的寄存器偏移：

| 偏移量 | 寄存器名称 | 描述 |
|--------|------------|------|
| 0x00   | CTRL | 通道控制寄存器 |
| 0x04   | STATUS | 通道状态寄存器 |
| 0x08   | SRC_ADDR | 源地址寄存器 |
| 0x0C   | DST_ADDR | 目标地址寄存器 |
| 0x10   | TRANS_SIZE | 传输大小寄存器(字节) |
| 0x14   | PERI_ADDR | 外设地址寄存器 |

## 寄存器位定义

### 通道控制寄存器(CTRL)位定义

| 位 | 名称 | 描述 |
|----|------|------|
| 0  | ENABLE | 通道使能 |
| 1  | START | 开始传输 (软件触发) |
| 2  | DIR | 传输方向 (0=外设到内存, 1=内存到外设) |
| 3  | INT_EN | 中断使能 |
| 4  | AUTO | 自动模式 (响应硬件请求) |

### 通道状态寄存器(STATUS)位定义

| 位 | 名称 | 描述 |
|----|------|------|
| 0  | ACTIVE | 通道活动状态 |
| 1  | DONE | 传输完成标志 |
| 2  | ERR | 错误标志 |

## AHB-Lite接口

DMA控制器提供两个AHB-Lite接口：

1. **从接口** - 用于处理CPU对DMA寄存器的读写操作
2. **主接口** - DMA作为总线主设备，访问系统内存

### AHB-Lite信号描述

#### 从接口信号 (CPU访问DMA)

| 信号名 | 方向 | 描述 |
|--------|------|------|
| s_hsel | 输入 | 从设备选择 |
| s_haddr | 输入 | 地址总线 |
| s_hwrite | 输入 | 写入使能 (1=写,0=读) |
| s_htrans | 输入 | 传输类型 |
| s_hsize | 输入 | 传输大小 |
| s_hburst | 输入 | 突发类型 |
| s_hwdata | 输入 | 写数据总线 |
| s_hrdata | 输出 | 读数据总线 |
| s_hready | 输出 | 就绪信号 |
| s_hresp | 输出 | 传输响应 |

#### 主接口信号 (DMA访问内存)

| 信号名 | 方向 | 描述 |
|--------|------|------|
| m_hbusreq | 输出 | 总线请求 |
| m_hgrant | 输入 | 总线授权 |
| m_haddr | 输出 | 地址总线 |
| m_hwrite | 输出 | 写入使能 (1=写,0=读) |
| m_htrans | 输出 | 传输类型 |
| m_hsize | 输出 | 传输大小 |
| m_hburst | 输出 | 突发类型 |
| m_hwdata | 输出 | 写数据总线 |
| m_hrdata | 输入 | 读数据总线 |
| m_hready | 输入 | 就绪信号 |
| m_hresp | 输入 | 传输响应 |

### AHB-Lite传输类型 (HTRANS)

| 值 | 名称 | 描述 |
|----|------|------|
| 00 | IDLE | 空闲传输，不进行任何传输 |
| 01 | BUSY | 忙状态，指示主设备无法继续传输 |
| 10 | NONSEQ | 非顺序传输，首次传输或与前一个地址不连续 |
| 11 | SEQ | 顺序传输，与前一个地址连续 |

### AHB-Lite传输大小 (HSIZE)

| 值 | 描述 |
|----|------|
| 000 | 8位 (字节) |
| 001 | 16位 (半字) |
| 010 | 32位 (字) - DMA控制器使用这种大小 |
| 011 | 64位 |
| 100 | 128位 |
| 101 | 256位 |
| 110 | 512位 |
| 111 | 1024位 |

### AHB-Lite突发类型 (HBURST)

| 值 | 名称 | 描述 |
|----|------|------|
| 000 | SINGLE | 单次传输 - DMA控制器主要使用这种类型 |
| 001 | INCR | 未定义长度的递增突发 |
| 010 | WRAP4 | 4拍环绕突发 |
| 011 | INCR4 | 4拍递增突发 |
| 100 | WRAP8 | 8拍环绕突发 |
| 101 | INCR8 | 8拍递增突发 |
| 110 | WRAP16 | 16拍环绕突发 |
| 111 | INCR16 | 16拍递增突发 |

## 使用方法

### 配置和启动一个软件触发DMA传输

1. 确保全局DMA控制器已启用 (写入GLOBAL_CTRL寄存器)
2. 配置通道的源地址和目标地址
3. 设置传输大小
4. 配置外设地址
5. 配置通道控制寄存器启动传输 (设置ENABLE和START位)
6. 可选：使能中断通知
7. 等待传输完成 (轮询STATUS寄存器或等待中断)

### 内存到外设传输示例 (软件触发)

```verilog
// 全局DMA使能
write(0x10000000, 0x00000001);

// 使能中断
write(0x1000000C, 0x00000001);  // 使能通道0的中断

// 配置通道0
write(0x10001008, 0x20000000);  // 源地址: 内存地址
write(0x1000100C, 0x00000000);  // 目标地址: 不使用，外设地址单独配置
write(0x10001010, 0x00000100);  // 传输大小: 256字节
write(0x10001014, 0x40000000);  // 外设地址: 外设寄存器地址
write(0x10001000, 0x0000000D);  // 控制: 使能(bit0) + 开始(bit1) + 方向(bit2=1) + 中断使能(bit3)

// 等待传输完成
while ((read(0x10001004) & 0x02) == 0) {
    // 等待DONE位被置位
}

// 或者等待中断触发
// 中断处理后，清除中断状态
write(0x10000008, 0x00000001);  // 写1清零通道0的中断状态
```

### 外设到内存传输示例 (硬件触发)

```verilog
// 全局DMA使能
write(0x10000000, 0x00000001);

// 使能中断
write(0x1000000C, 0x00000004);  // 使能通道2的中断

// 配置通道2
write(0x10001208, 0x00000000);  // 源地址: 不使用，外设地址单独配置
write(0x1000120C, 0x20001000);  // 目标地址: 内存缓冲区
write(0x10001210, 0x00000200);  // 传输大小: 512字节
write(0x10001214, 0x40000000);  // 外设地址: 外设寄存器地址
write(0x10001200, 0x00000019);  // 控制: 使能(bit0) + 外设到内存(bit2=0) + 中断使能(bit3) + 自动模式(bit4)

// 当外设发出请求后，DMA会自动传输
// 等待中断指示传输完成
// 中断处理后，清除中断状态
write(0x10000008, 0x00000004);  // 写1清零通道2的中断状态
```

## AHB-Lite集成指南

### DMA从设备接口(供CPU访问)
DMA控制器接收来自CPU的命令和寄存器访问请求通过AHB-Lite从接口。集成时需要:
1. 将从接口连接到AHB-Lite总线
2. 设置适当的地址解码，确保DMA寄存器地址映射到正确的区域
3. 配置`s_hsel`信号以正确选择DMA控制器
4. 确保所有必要的AHB-Lite信号都正确连接

### DMA主设备接口(用于内存访问)
DMA控制器作为AHB-Lite总线上的主设备访问内存。需要:
1. 连接到系统总线仲裁器，以便获得总线访问权限
2. 处理`m_hbusreq`和`m_hgrant`信号，确保正确的总线仲裁
3. 确保DMA控制器能够访问所有必要的内存和外设地址空间

### AHB-Lite时序注意事项
1. **地址阶段**：在地址阶段，主设备驱动地址、传输类型和方向信号
2. **数据阶段**：在数据阶段，对于写操作，主设备驱动数据；对于读操作，从设备驱动数据
3. **HREADY信号**：这个信号可以延长传输周期，用于处理慢速设备
4. **HTRANS信号**：确保正确使用传输类型，特别是IDLE和NONSEQ

### 中断处理
DMA传输完成后会生成中断。需要:
1. 将DMA中断信号连接到系统中断控制器
2. 配置中断处理程序处理DMA完成事件
3. 中断服务程序中清除中断状态

## 调试技巧

1. **状态监控**：定期读取STATUS寄存器确认通道是否活动或完成
2. **中断处理**：在中断处理程序中检查INT_STATUS以确定哪个通道触发了中断
3. **错误检查**：如果传输未完成，检查STATUS寄存器的ERR位以判断是否有错误
4. **AHB传输监控**：可以使用总线监视器跟踪AHB-Lite总线上的传输
5. **波形调试**：使用波形查看器检查AHB-Lite信号时序，确保符合协议要求

## 性能优化

1. **突发传输**：连续地址的数据将获得最佳性能，因为这允许更高效的内存访问
2. **通道优先级**：仲裁器使用轮询机制，确保所有通道获得公平的总线访问机会
3. **传输大小**：最小传输单位是4字节(一个字)，传输大小应为4的倍数
4. **总线仲裁优化**：在系统级别调整DMA总线请求优先级，以平衡系统性能
5. **内存对齐**：确保源和目标地址都是4字节对齐的，以获得最佳性能

## 已知限制

1. 当前实现只支持32位数据宽度传输
2. 不支持环绕突发模式，只支持单次和递增传输
3. 传输大小必须是4字节的倍数
4. 所有访问地址必须4字节对齐

# PPT转视频工具

一个能够将PowerPoint演示文稿转换为带有旁白的视频的工具。

## 功能特点

- 自动提取PPT中的图像
- 从最后一页提取旁白文本
- 生成语音旁白
- 将幻灯片和旁白合成为视频
- 在视频底部添加字幕

## 使用方法

1. 运行应用程序：
   ```
   python app.py
   ```

2. 选择PPT文件和输出视频文件
3. 选择语音引擎（系统TTS或谷歌TTS）
4. 点击"转换"按钮开始处理

## 注意事项

1. 最后一页PPT应包含每一页的旁白文本
2. 推荐使用"page1：文本"的格式在最后一页组织旁白内容
3. 如果想使用更高级的字幕效果，请安装ImageMagick：
   - 下载地址：https://imagemagick.org/script/download.php
   - 安装后修改moviepy的配置文件，指定ImageMagick路径

## 故障排除

如果遇到问题，请检查：
- 确保PPT文件格式正确，并包含旁白文本
- 检查是否安装了所有必要的Python包
- 如果字幕效果不理想，可以考虑安装ImageMagick以获得更好的文本渲染

## 语音合成引擎

该工具支持两种语音合成引擎：

1. **系统TTS (pyttsx3)** - 使用本地计算机的语音合成功能，不需要网络连接
2. **科大讯飞TTS** - 使用科大讯飞的专业语音合成服务，提供更自然的中文发音

### 科大讯飞语音配置

要使用科大讯飞语音合成功能，您需要：

1. 访问[科大讯飞开放平台](https://www.xfyun.cn/)注册账号
2. 创建一个语音合成应用
3. 获取以下信息：
   - APPID
   - API Key
   - API Secret
4. 在应用界面中选择"科大讯飞TTS"选项，并填入上述信息
5. 选择合适的发音人（如：xiaoyan-女声，aisjiuxu-男声，等）

科大讯飞的语音合成质量更高，特别适合中文旁白的生成。
